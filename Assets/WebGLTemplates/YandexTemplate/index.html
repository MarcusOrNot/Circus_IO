<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>{{{ PRODUCT_NAME }}}</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width=1920 height=1080></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
    <script>

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");

      // Shows a temporary message banner/ribbon for a few seconds, or
      // a permanent error message on top of the canvas if type=='error'.
      // If type=='warning', a yellow highlight color is used.
      // Modify or remove this function to customize the visually presented
      // way that non-critical warnings and error messages are presented to the
      // user.

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}"
      var config = {
        dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
        frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
        codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
#if MEMORY_FILENAME
        memoryUrl: buildUrl + "/{{{ MEMORY_FILENAME }}}",
#endif
#if SYMBOLS_FILENAME
        symbolsUrl: buildUrl + "/{{{ SYMBOLS_FILENAME }}}",
#endif
        streamingAssetsUrl: "StreamingAssets",
        companyName: "{{{ COMPANY_NAME }}}",
        productName: "{{{ PRODUCT_NAME }}}",
        productVersion: "{{{ PRODUCT_VERSION }}}",
      };

      /*if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:

        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        container.className = "unity-mobile";
        canvas.className = "unity-mobile";

        // To lower canvas resolution on mobile devices to gain some
        // performance, uncomment the following line:
        // config.devicePixelRatio = 1;


      } else {
        // Desktop style: Render the game canvas in a window that can be maximized to fullscreen:

        canvas.style.width = "960px";
        canvas.style.height = "600px";
      }*/

      loadingBar.style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
              }).then((unityInstance) => {
			  window.unityInstance = _unityInstance;
                loadingBar.style.display = "none";
              }).catch((message) => {
                alert(message);
              });
            };

      document.body.appendChild(script);

    </script>
	
	<!-- Yandex Games SDK -->
<script src="https://yandex.ru/games/sdk/v2"></script>


<script>

var player;
  var sdk;
  var payments = null;
  var lb=null;

YaGames
    .init()
    .then(ysdk => {
        console.log('Yandex SDK initialized');
        //window.ysdk = ysdk;
		sdk = ysdk;
		sdk.adv.showFullscreenAdv({ callbacks: {} });
    });

</script>

<script>
	function auth(){
        sdk.auth.openAuthDialog().then(() => {
                // Игрок успешно авторизован, теперь объект Player будет инициализирован.
                initPlayer(()=>{
					console.log('player id is '+player.getUniqueID());
					sendPlayerData();
				});
                console.log('auth ok');
            }).catch(() => {
                 // Игрок не авторизован.
                 console.log('auth failed');
				 gameInstance.SendMessage('YandexSDK', 'OnAuthFailed', 'auth failed');
            });
      }

      function initPlayer(onInit){
			sdk.getPlayer({ scopes: false }).then(_player => {
				if (_player.getMode() === 'lite') return;
                player = _player; 
				sdk.getLeaderboards()
						.then(_lb => lb=_lb);
				if (onInit!=null) onInit.call();
            }).then(() => {
				getLanguage();
			}).catch(err => {
			console.log('error here it is on init player '+err);
                // Если игрок не авторизован, выбрасывает исключение USER_NOT_AUTHORIZED.
				gameInstance.SendMessage('YandexSDK', 'OnAuthFailed', err);
            });
      }

      function getUserData() {
		  initPlayer(()=>{
			console.log('player id is '+player.getUniqueID());
			sendPlayerData();
			//getLanguage();
		  });
      }
	  
	  function sendPlayerData() {
		var data = {"id" : player.getUniqueID(), "name" : player.getName(), "avatarUrlSmall" : player.getPhoto('small'), "avatarUrlMedium" : player.getPhoto('medium'), "avatarUrlLarge" : player.getPhoto('large')};
			gameInstance.SendMessage('YandexSDK', 'StoreUserData', JSON.stringify(data));
	  }
	  
	  function setGameData(gamedataString) {
			player.setData(JSON.parse(gamedataString)).then(() => {
				console.log('data is set');
			});
	  }
	  
	  function setGameStat(statdataString) {
		console.log('for set stat = '+statdataString);
		player.setStats(JSON.parse(statdataString)).then(()=>{
			console.log('stat data saved');
		}).catch(() => {
			console.log('on stat saving error');
            });
	  }
	  
	  function getGameData(keyJSON) {
		var resPromise=(keyJSON==""?player.getData():player.getData(JSON.parse(keyJSON)['keys']));
		resPromise.then(gameData=>{
			gameInstance.SendMessage('YandexSDK', 'GameJSONReceived', JSON.stringify(gameData));
		}).catch(err => {
			console.log('on data get error '+err);
            });
	  }
	  
	  function getGameStat(keyJSON) {
		var resPromise=(keyJSON==""?player.getStats():player.getStats(JSON.parse(keyJSON)['keys']));
		resPromise.then(statData=>{
			gameInstance.SendMessage('YandexSDK', 'GameStatJSONReceived', JSON.stringify(statData));
		}).catch(err => {
			console.log('on data get error '+err);
            });
	  }
	  
	  function getLeaderboard(leaderboardName, quantityTop, includeUser, quantityAround) {
		if (player==null || lb==null) return;
		lb.getLeaderboardEntries(leaderboardName, { quantityTop: quantityTop, includeUser: includeUser, quantityAround: quantityAround })
      .then(res => gameInstance.SendMessage('YandexSDK', 'LeaderboardJSONReceived', JSON.stringify(res)));
	  }
	  
	  function setLeaderboardScore(leaderboardName, score) {
		if (lb==null) return;
		console.log('leaderboard_name'+leaderboardName+', score is '+score);
		lb.setLeaderboardScore(leaderboardName, score);
	  }
	  
	  function getLanguage() {
		gameInstance.SendMessage('YandexSDK', 'SetYandexLanguage', JSON.stringify(sdk.environment.i18n.lang));				
		console.log('lang = ' + JSON.stringify(sdk.environment.i18n.lang));
	  }
</script>

<!-- Обработка рекламы в нужное время -->
<script>
  function showFullscrenAd() {
    sdk.adv.showFullscreenAdv({
      callbacks: {
        onClose: function (wasShown) {
          gameInstance.SendMessage('YandexSDK', 'OnInterstitialShown');
        },
        onError: function (error) {
          gameInstance.SendMessage('YandexSDK', 'OnInterstitialFailed', error);
        }
      }
    })
  }
</script>

<!-- Обработка рекламы за вознаграждение -->
<script>
  function showRewardedAd(id) {
    sdk.adv.showRewardedVideo({
      callbacks: {
        onOpen: () => {
          gameInstance.SendMessage('YandexSDK', 'OnRewardedOpen', id);
          console.log('Video ad open. Id: ' + id);
        },
        onRewarded: () => {
          gameInstance.SendMessage('YandexSDK', 'OnRewarded', id);
          console.log('Rewarded! Id: ' + id);
        },
        onClose: () => {
          gameInstance.SendMessage('YandexSDK', 'OnRewardedClose', id);
          console.log('Video ad closed. Id: ' + id);
        },
        onError: (e) => {
          var data = { "id": id, "error": error };
          gameInstance.SendMessage('YandexSDK', 'OnRewardedError', JSON.stringify(data));
          console.log('Error while open video ad:', e);
        }
      }
    })
  }
</script>

<script>
var gameShop=[];
	function initPayments(onInit){
		if (payments!=null) if (onInit!=null) {
			onInit.call();
			return;
		}
		if (sdk==null) return;
        sdk.getPayments().then(_payments => {
			console.log("payment is init");
          // Покупки доступны.
          payments = _payments;
		  if (onInit!=null) onInit.call();
        }).catch(err => {
			console.log("error on payment "+err);
        })
      }

      function buy(id){
		initPayments(()=>{
			console.log('buy id is '+id);
			payments.purchase({id:id}).then(purchase => {
			console.log('success buy id is '+id);
			  // Покупка успешно совершена!
			  gameInstance.SendMessage('YandexSDK', 'OnPurchaseSuccessYandex', id);
			  window.focus();
			}).catch(err => {
			  // Покупка не удалась: в консоли разработчика не добавлен товар с таким id,
			  // пользователь не авторизовался, передумал и закрыл окно оплаты,
			  // истекло отведенное на покупку время, не хватило денег и т. д.
			  gameInstance.SendMessage('YandexSDK', 'OnPurchaseFailed', JSON.stringify(err));
			  window.focus();
			});
		});
      }
	  
	  function getCatalog() {
		initPayments(()=>{
			payments.getCatalog().then(products => {
			gameShop = products;
			var catalog = new Object();
			catalog['catalog']=gameShop;
			gameInstance.SendMessage('YandexSDK', 'InapCatalogJSONReceived', JSON.stringify(catalog));
			});
		
		});
		
	  }
	  
	  function getPurchases() {
		initPayments(()=>{
			payments.getPurchases().then(purchasesElems => {
				//console.log('purchases is '+JSON.stringify(purchases));
				var purchases = new Object();
				purchases['purchases']=purchasesElems;
				gameInstance.SendMessage('YandexSDK', 'PurchasesJSONReceived', JSON.stringify(purchases));
			}).catch(err => {
				console.log('Get purchases error '+err);
				// Выбрасывает исключение USER_NOT_AUTHORIZED для неавторизованных пользователей.
			});
		});	
	  }

</script>
	
  </body>
</html>
